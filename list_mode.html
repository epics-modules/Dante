<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>List mode &mdash; EPICS support for Dante X-ray spectrometers</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/my_theme.css?v=254ed751" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="ADC trace waveforms" href="adc_trace_waveforms.html" />
    <link rel="prev" title="MCA mapping mode" href="mca_mapping_mode.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Dante
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="system_controls.html">System controls</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration_parameters.html">Configuration parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="run_time_statistics.html">Run-time statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="medm_screens.html">medm screens</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi_element_systems.html">Multi-element systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="mca_mode.html">MCA mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="mca_mapping_mode.html">MCA mapping mode</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">List mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="adc_trace_waveforms.html">ADC trace waveforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="ioc_startup_script.html">IOC startup script</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">Performance</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Dante</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">List mode</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/list_mode.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="list-mode">
<h1>List mode<a class="headerlink" href="#list-mode" title="Link to this heading"></a></h1>
<p>These are the records for list mode.  They are contained in dante.template.</p>
<table class="table-bordered table-striped table-hover docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>EPICS record names</p></th>
<th class="head"><p>Record types</p></th>
<th class="head"><p>drvInfo string</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>CurrentPixel</p></td>
<td><p>longin</p></td>
<td><p>DanteCurrentPixel</p></td>
<td><p>In List mode this is the total number of x-ray events received so far.</p></td>
</tr>
<tr class="row-odd"><td><p>ListBufferSize, ListBufferSize_RBV</p></td>
<td><p>longout, longin</p></td>
<td><p>DanteListBufferSize</p></td>
<td><p>The number of x-ray events per buffer in list mode.
Once this number of events has been received the events read from the Dante
stored in NDArrays, and callbacks are done to any registered plugins.</p></td>
</tr>
</tbody>
</table>
<p>List mode events are 64-bit unsigned integers.</p>
<ul class="simple">
<li><p>Bits 0 to 15 are the x-ray energy, i.e. ADC value.</p></li>
<li><p>Bits 16 to 17 are not used.</p></li>
<li><p>Bits 18 to 61 are the timestamp in 8 ns units.</p></li>
<li><p>Bits 62 and 63 are not used.</p></li>
</ul>
<p>In list mode the x-ray events are copied into NDArrays.
The data type of the NDArrays is NDUInt64, and the NDArrayDimensions are [ListBufferSize, NumBoards].
For a 1-channel Dante NumBoards is 1.</p>
<p>The run-time statistics for ListBufferSize events are copied into NDAttributes attached to each
NDArray. The attribute names contain the board number, for example “RealTime_0”.
Note that these statistics are cummulative for the entire acquisition, not just since the
last time the event buffer was read.
By making ListBufferSize smaller one obtains a more frequent sampling of these statistics.</p>
<p>These statistics also update the run-time statistics records described above, so there is feedback
while the list mode acquisition is in progress.</p>
<p>The first NumMCAChannels events are copied to the buffer for the MCA record for each board.
In this case the MCA record will not contain an x-ray spectrum, but rather will contain the x-ray
energy in ADC units on the vertical axis and the event number on the horizontal axis.</p>
<p>The NDArrays can be used by most of the standard areaDetector plugins.  For example, they can be streamed
to HDF5 or TIFF files.  List-mode data cannot be written to a netCDF file, because the netCDF classic format
does not support 64-bit integer data types.</p>
<p>The following is an IDL procedure to read the List mode data from an HDF5 file into two arrays, “energy” and “time”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pro</span> <span class="n">read_dante_list_data</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">time</span>
   <span class="n">data</span> <span class="o">=</span> <span class="n">read_nd_hdf5</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
   <span class="n">energy</span> <span class="o">=</span> <span class="n">uint</span><span class="p">(</span><span class="n">data</span> <span class="ow">and</span> <span class="s1">&#39;ffff&#39;</span><span class="n">x</span><span class="p">)</span>
   <span class="n">time</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="n">ishft</span><span class="p">((</span><span class="n">data</span> <span class="ow">and</span> <span class="s1">&#39;3ffffffffffc0000&#39;</span><span class="n">x</span><span class="p">),</span> <span class="o">-</span><span class="mi">18</span><span class="p">))</span><span class="o">*</span><span class="mf">8e-9</span>
<span class="n">end</span>
</pre></div>
</div>
<p><a href="#id1"><span class="problematic" id="id2">read_nd_hdf5_</span></a> is a function that reads an HDF5 file written by the areaDetector NDFileHDF5 plugin:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">read_nd_hdf5</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="nb">range</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">n_elements</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="n">eq</span> <span class="mi">0</span><span class="p">)</span> <span class="n">then</span> <span class="n">dataset</span> <span class="o">=</span> <span class="s1">&#39;/entry/data/data&#39;</span>
  <span class="n">file_id</span> <span class="o">=</span> <span class="n">h5f_open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
  <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">h5d_open</span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">h5d_read</span><span class="p">(</span><span class="n">dataset_id</span><span class="p">)</span>
  <span class="n">h5d_close</span><span class="p">,</span> <span class="n">dataset_id</span>
  <span class="n">h5f_close</span><span class="p">,</span> <span class="n">file_id</span>
  <span class="k">return</span><span class="p">,</span> <span class="n">data</span>
<span class="n">end</span>
</pre></div>
</div>
<p>The following is a plot of the energy events for the first 1 second of that data, using this IDL command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">IDL</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">xrange</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">yrange</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">20000</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s1">&#39;plus&#39;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-center">
<img alt="_images/dante_idl_list_plot.png" src="_images/dante_idl_list_plot.png" />
</figure>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mca_mapping_mode.html" class="btn btn-neutral float-left" title="MCA mapping mode" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="adc_trace_waveforms.html" class="btn btn-neutral float-right" title="ADC trace waveforms" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Mark Rivers.
      <span class="lastupdated">Last updated on 2024-January-04.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>